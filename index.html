<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEILOG - Assistente de Log√≠stica</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tone.js para efeitos sonoros -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <!-- IMask.js para m√°scaras de formul√°rio -->
    <script src="https://unpkg.com/imask"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --heineken-green: #00904A;
            --heineken-red: #E50025;
            --dark-bg: #174017;
            --text-light: #f3f4f6;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--dark-bg); color: var(--text-light); }
        .font-title { font-family: 'Oswald', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        .card { background-color: rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .form-input, .form-select { background-color: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: white; }
        .form-input:focus, .form-select:focus { border-color: var(--heineken-green); box-shadow: 0 0 0 2px rgba(0, 144, 74, 0.5); outline: none; }
        .btn-green { background-color: var(--heineken-green); color: white; font-weight: bold; }
        .btn-green:hover { background-color: #007a3f; }
        .btn-ghost { background: rgba(255,255,255,0.08); color: white; border: 1px solid rgba(255,255,255,0.12); font-weight: 700; }
        .btn-ghost:hover { background: rgba(255,255,255,0.14); }
        .btn-danger { background-color: var(--heineken-red); color: white; font-weight: bold; }
        .btn-danger:hover { background-color: #c6001f; }
        .form-input.invalid { border-color: var(--heineken-red); box-shadow: 0 0 0 2px rgba(229, 0, 37, 0.5); }
        #call-panel-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        #call-panel-content { padding: 3rem; border-radius: 1rem; text-align: center; color: #1a202c; animation: fadeIn 0.3s ease-out; }
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { position: absolute; left: 0; top: 0; width: 100%; }
            .print-main-container { border: 4px solid black !important; padding: 1rem; color: black !important; }
            #app-container, #call-panel-overlay { display: none; }
        }
    
        /* ‚úÖ Menu tiles (modo inicial) */
        .mode-tile { min-height: 74px; }
        .mode-tile .emoji { font-size: 26px; line-height: 1; }
        .mode-tile .label { font-size: 0.98rem; }

        /* ‚úÖ Alto contraste (somente nas op√ß√µes) */
        .hc .mode-btn {
            background: rgba(255,255,255,0.12);
            border-color: rgba(255,255,255,0.25);
        }
        .hc .mode-btn:hover { background: rgba(255,255,255,0.18); }
        .hc .mode-btn:focus { outline: 2px solid rgba(0, 144, 74, 0.65); outline-offset: 2px; }

    </style>
</head>
<body class="antialiased">

    <!-- Painel de Chamada -->
    <div id="call-panel-overlay">
        <div id="call-panel-content" class="w-full max-w-2xl">
            <h2 id="call-panel-message" class="text-4xl md:text-6xl font-bold uppercase mb-6"></h2>
            <button id="close-panel-btn" class="bg-white/80 hover:bg-white text-gray-800 font-bold py-3 px-8 rounded-lg transition-all">Fechar</button>
        </div>
    </div>

    <div id="app-container" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md card shadow-2xl rounded-2xl p-8 space-y-6">
            <div class="text-center">
                <svg class="w-20 h-20 mx-auto mb-2" viewBox="0 0 24 24" fill="#E50025" xmlns="http://www.w3.org/2000/svg"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27z"/></svg>
                <h1 class="font-title text-5xl font-bold text-white uppercase tracking-wider">HEILOG</h1>
                <p class="text-gray-400 mt-1">Seu assistente de log√≠stica.</p>
            </div>

            <!-- ‚úÖ NOVO: passo inicial (o que voc√™ quer fazer?) -->
            <div id="action-area" class="space-y-4"></div>

            <div id="results-area" class="pt-2 min-h-[5rem]"></div>

            <div class="text-center pt-4 border-t border-gray-700/50">
                <p id="file-status" class="text-yellow-400 text-xs h-4"></p>
            </div>
        </div>
    </div>

    <div id="printable-area"></div>

    <script type="module">
        // Importar as fun√ß√µes necess√°rias do SDK do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Vari√°veis Globais e Constantes ---
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSHLJspPB5rUhpKWTUFGrtMeksd24eu1-I_l5S2qkhgFsie6cn1hITIUmr3k-ZuL4stm1x8MT0mC30s/pub?output=csv';

        // Proxy principal + fallbacks (se um cair, tenta o pr√≥ximo)
        const CORS_PROXY_URL = 'https://api.allorigins.win/raw?url=';
        const EXTRA_PROXY_BUILDERS = [
            // corsproxy.io
            (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
            // codetabs
            (url) => `https://api.codetabs.com/v1/proxy/?quest=${encodeURIComponent(url)}`,
        ];

        const FETCH_TIMEOUT_MS = 15000;
        const REFRESH_INTERVAL = 300000; // 5 minutos

        // --- Elementos do DOM ---
        const fileStatus = document.getElementById('file-status');
        const resultsArea = document.getElementById('results-area');
        const actionArea = document.getElementById('action-area');
        const callPanelOverlay = document.getElementById('call-panel-overlay');
        const callPanelContent = document.getElementById('call-panel-content');
        const callPanelMessage = document.getElementById('call-panel-message');
        const closePanelBtn = document.getElementById('close-panel-btn');

        // --- Vari√°veis de Estado da Aplica√ß√£o ---
        let db, auth, appId;
        let isAuthReady = false;
        let database = [];
        let headers = [];
        let headerMap = {};
        let panelTimeout;
        let cpfMask, phoneMask;

        // ‚úÖ NOVO: estado do fluxo (layout novo)
        let currentMode = null;                 // LOAD | UNLOAD | BOTH | LATA_INSUMO | RITMO
        let isSheetReady = false;               // base do Sheets carregou?
        let pendingUnloadDt = '';               // DT de descarga para preencher no form
        let requireUnloadDtInForm = false;      // valida DT descarga no form?
        let manualPresetType = '';              // "Latas" | "Insumo" | "Descarga" | "Ritmo"...
        let manualDtIdOverride = '';            // quando n√£o tem DT, gera um ID
        let hideManualExtras = false;           // deixa manual mais "enxuto" (oculta cliente/plt)
        let showUnloadInputs = true;            // mostra bloco Nota Fiscal / DT Descarga no form?

        // --- Helpers ---
        function normalizeDtId(dt) {
            // Firestore docId n√£o pode ter "/". Ent√£o, por seguran√ßa, mantemos s√≥ n√∫meros.
            const onlyDigits = String(dt || '').replace(/\D/g, '');
            return onlyDigits;
        }

        function generateInternalId(prefix) {
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const id = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
            return `${prefix}_${id}`;
        }

        // --- Audio Unlock (evita erro do AudioContext / autoplay) ---
        let audioUnlocked = false;
        async function unlockAudio() {
            if (audioUnlocked) return true;
            try {
                await Tone.start();
                audioUnlocked = true;
                return true;
            } catch (e) {
                console.warn("N√£o foi poss√≠vel destravar √°udio:", e);
                return false;
            }
        }
        document.addEventListener('pointerdown', () => unlockAudio(), { once: true });

        async function fetchWithTimeout(url, timeoutMs = FETCH_TIMEOUT_MS) {
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), timeoutMs);
            try {
                return await fetch(url, { cache: 'no-store', credentials: 'omit', signal: controller.signal });
            } finally {
                clearTimeout(timer);
            }
        }

        // --- CONFIGURA√á√ÉO DO FIREBASE ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyB9B2-xYb6gr92cQDbajriQiinfQurrOwI",
            authDomain: "heilog-logistica.firebaseapp.com",
            projectId: "heilog-logistica",
            storageBucket: "heilog-logistica.appspot.com",
            messagingSenderId: "790492229739",
            appId: "1:790492229739:web:de49887de535a839e8412e"
        };
        const ARTIFACT_APP_ID = "heilog-logistica";
        // ------------------------------------

        // --- FUN√á√ïES DE INICIALIZA√á√ÉO E AUTENTICA√á√ÉO ---
        async function authenticate() {
            return new Promise(async (resolve, reject) => {
                onAuthStateChanged(auth, (user) => {
                    if (user && !isAuthReady) {
                        console.log("Firebase Auth pronta. UID:", user.uid);
                        isAuthReady = true;
                        resolve(user);
                    }
                });

                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else if (!auth.currentUser) {
                        await signInAnonymously(auth);
                    } else {
                        isAuthReady = true;
                        resolve(auth.currentUser);
                    }
                } catch (error) {
                    console.error("Falha na autentica√ß√£o com o Firebase:", error);
                    displayError("Falha na autentica√ß√£o. A aplica√ß√£o pode n√£o funcionar corretamente.");
                    reject(error);
                }
            });
        }

        async function initializeAppLogic() {
            fileStatus.textContent = 'Inicializando...';

            // ‚úÖ Layout novo: j√° desenha o menu inicial
            renderActionSelector();

            // 1. Inicializar Firebase
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                appId = ARTIFACT_APP_ID;
                console.log("[HEILOG] appId usado:", appId);
                console.log('[HEILOG] Firestore APPID em uso:', appId);
                setLogLevel('error');
            } catch (e) {
                console.error("Erro ao inicializar o Firebase:", e);
                fileStatus.textContent = "Erro cr√≠tico na inicializa√ß√£o.";
                fileStatus.className = 'text-red-400 text-xs h-4';
                return;
            }

            // 2. Aguardar autentica√ß√£o
            try {
                fileStatus.textContent = 'Autenticando...';
                await authenticate();
                fileStatus.textContent = 'Autenticado com sucesso. AppID: ' + appId;
            } catch (e) {
                fileStatus.textContent = "Erro na autentica√ß√£o.";
                fileStatus.className = 'text-red-400 text-xs h-4';
                return;
            }

            // 3. Carregar dados da planilha (s√≥ necess√°rio para fluxos com DT)
            await loadDataFromSheet(false);

            // 4. Configurar atualiza√ß√µes peri√≥dicas
            setInterval(() => {
                // Se estiver no formul√°rio de motorista, evita recarregar no meio da digita√ß√£o
                if (!document.getElementById('generate-sheet-btn')) {
                    loadDataFromSheet(true);
                }
            }, REFRESH_INTERVAL);
        }

        // --- FUN√á√ïES DE DADOS E L√ìGICA DE NEG√ìCIO ---
        async function loadDataFromSheet(isSilent = false) {
            if (!isSilent) fileStatus.textContent = 'Conectando √† planilha...';

            try {
                const baseUrl = `${GOOGLE_SHEET_CSV_URL}${GOOGLE_SHEET_CSV_URL.includes('?') ? '&' : '?'}t=${Date.now()}`;

                const candidates = [
                    `${CORS_PROXY_URL}${encodeURIComponent(baseUrl)}`,
                    ...EXTRA_PROXY_BUILDERS.map(fn => fn(baseUrl)),
                    baseUrl,
                ];

                let csvText = '';
                let lastErr = null;

                for (const url of candidates) {
                    try {
                        const response = await fetchWithTimeout(url);
                        if (!response.ok) throw new Error(`Falha na rede (${response.status}): ${response.statusText}`);
                        csvText = await response.text();
                        if (csvText && csvText.trim().length > 0) break;
                    } catch (e) {
                        lastErr = e;
                    }
                }

                if (!csvText) throw lastErr || new Error('Falha ao buscar CSV.');

                parseCSV(csvText);

                const lastUpdatedTime = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                fileStatus.textContent = `Planilha atualizada √†s ${lastUpdatedTime}.`;
                fileStatus.className = 'text-green-400 text-xs h-4';

                isSheetReady = database.length > 0;
                updateModeAvailability();

            } catch (error) {
                const lastErrorTime = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                fileStatus.textContent = `Erro ao atualizar √†s ${lastErrorTime}.`;
                fileStatus.className = 'text-red-400 text-xs h-4';
                console.error("Erro ao buscar dados da planilha:", error);

                isSheetReady = database.length > 0;
                updateModeAvailability();

                if (database.length > 0) {
                    if (!isSilent) displayError('N√£o foi poss√≠vel atualizar agora, mas vou usar a √∫ltima base carregada.', 5000);
                } else {
                    if (!isSilent) displayError('N√£o foi poss√≠vel conectar √† planilha. Fluxos com DT ficar√£o indispon√≠veis.', 6000);
                }
            }
        }

        function parseCSV(csvText) {
            const cleaned = csvText.replace(/^\uFEFF/, '');
            const lines = cleaned.trim().split(/\r?\n/);
            if (lines.length < 2) return;

            const parseLine = (line) => {
                const values = [];
                const regex = /("([^"]|"")*"|[^,]*)(,|$)/g;
                line.replace(regex, (match, p1) => {
                    let value = p1;
                    if (value.startsWith('"') && value.endsWith('"')) value = value.slice(1, -1).replace(/""/g, '"');
                    values.push(value.trim());
                });
                return values;
            };

            headers = parseLine(lines[0]).map(h => h.toUpperCase().replace(/"/g, ''));

            // ‚ö†Ô∏è Mantive seu mapeamento por ordem para n√£o quebrar seu CSV atual.
            // Se quiser, depois eu troco para mapeamento por NOME da coluna (mais robusto).
            headerMap = {
                dts: headers[0],
                canal: headers[1],
                cliente: headers[2],
                produto: headers[3],
                descricao: headers[4],
                plt: headers[5],
                deposito: headers[6],
                transportadora: headers[7],
                data: headers[8],
                descarga: headers[9],
                xtAdicional: headers[10],
                agenda: headers[11],
                cpf: headers.find(h => h.includes('CPF')),
                motorista: headers.find(h => h.includes('MOTORISTA')),
            };

            database = lines.slice(1).map(line => {
                if (line.trim() === '') return null;
                const values = parseLine(line);
                const entry = {};
                headers.forEach((header, j) => { entry[header] = values[j] || ''; });
                return entry;
            }).filter(Boolean);
        }

        // ‚úÖ ALTERA√á√ÉO: agora o p√°tio tamb√©m grava PRIORIDADE no Firestore (para o Painel conseguir ler sem "adivinhar")
        async function saveDriverData(driverData, originalSheetData, priorityInfo) {
            if (!isAuthReady || !db || !appId) {
                console.error("Firestore n√£o est√° pronto! Auth:", isAuthReady, "DB:", !!db, "AppID:", !!appId);
                displayError("Erro: Conex√£o com o banco de dados indispon√≠vel. Tente novamente.", 5000);
                return false;
            }

            const unmaskedCpf = driverData.cpf.replace(/\D/g, '');

            // Normaliza DT (Firestore docId seguro)
            const dtId = normalizeDtId(driverData.dts);
            if (!dtId) {
                displayError('ID inv√°lido: n√£o foi poss√≠vel salvar no p√°tio.', 5000);
                return false;
            }

            // 1. Salvar/Atualizar dados persistentes do motorista
            try {
                const driverDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'drivers', unmaskedCpf);
                const pInfoForDriver = priorityInfo || getPriorityInfo(originalSheetData || {});
                const persistentDriverData = {
                    name: driverData.name,
                    cpf: unmaskedCpf,
                    phone: driverData.phone.replace(/\D/g, ''),
                    cnh: driverData.cnh,
                    cnhExpiry: driverData.cnhExpiry,
                    truckPlate: driverData.truckPlate,
                    trailerPlate: driverData.trailerPlate,
                    axles: driverData.axles,
                    renavam: driverData.renavam,
                    transportadora: driverData.transportadora,
                    lastDts: driverData.dts || "",
                    lastPriority: {
                        label: pInfoForDriver.label || "",
                        isPriority: !!pInfoForDriver.isPriority,
                        isOtif: !!pInfoForDriver.isOtif,
                        isTop18: !!pInfoForDriver.isTop18,
                        isAntecipacao: !!pInfoForDriver.isAntecipacao,
                        isGradeQueimada: !!pInfoForDriver.isGradeQueimada,
                        isAtrasado: !!pInfoForDriver.isAtrasado,
                        reasons: pInfoForDriver.reasons || []
                    },
                    lastUpdate: new Date().toISOString()
                };
                await setDoc(driverDocRef, persistentDriverData, { merge: true });
                localStorage.setItem(`heilo-driver-${unmaskedCpf}`, JSON.stringify(persistentDriverData));
            } catch (error) {
                console.error("Erro ao salvar dados do motorista no Firestore:", error);
                displayError(`Erro ao salvar dados do motorista: ${error.message}`, 5000);
                return false;
            }

            // 2. Salvar dados da opera√ß√£o no p√°tio
            try {
                const patioDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'patio', dtId);
                console.log('[HEILOG] Gravando em:', `artifacts/${appId}/public/data/patio/${dtId}`);

                const pInfo = priorityInfo || getPriorityInfo(originalSheetData || {});
                const reasons = [];
                if (pInfo.isTop18) reasons.push("TOP 18");
                if (pInfo.isOtif) reasons.push("OTIF");
                if (pInfo.isAntecipacao) reasons.push("Antecipa√ß√£o");

                const label =
                    pInfo.isGradeQueimada ? "GRADE QUEIMADA" :
                    pInfo.isAtrasado ? "ATRASADO" :
                    pInfo.isPriority ? "PRIORIDADE" : "NORMAL";

                const level =
                    pInfo.isGradeQueimada ? 3 :
                    pInfo.isAtrasado ? 2 :
                    pInfo.isPriority ? 1 : 0;

                const canalValue = (originalSheetData?.[headerMap.canal] || '').toString().trim().toUpperCase();
                const segmentoValue = (originalSheetData?.[headerMap.xtAdicional] || '').toString();

                const patioDataToSave = {
                    dt: dtId,
                    motorista: driverData.name,
                    transportadora: driverData.transportadora,
                    cpf: unmaskedCpf,
                    placa: driverData.truckPlate,
                    telefone: driverData.phone.replace(/\D/g, ''),
                    registrationTime: driverData.registrationTime,
                    status: 'Em P√°tio',
                    agenda: originalSheetData?.[headerMap.agenda] || '',
                    xtAdicional: originalSheetData?.[headerMap.xtAdicional] || '',
                    data: originalSheetData?.[headerMap.data] || '',
                    origem: 'JACARE√ç/SP',
                    destino: originalSheetData?.[headerMap.deposito] || 'N/A',

                    // ‚úÖ Campos para Painel do Analista
                    canal: canalValue,
                    segmento: segmentoValue,
                    prioridade: {
                        label,
                        level,
                        reasons,
                        isPriority: !!pInfo.isPriority,
                        isOtif: !!pInfo.isOtif,
                        isTop18: !!pInfo.isTop18,
                        isAntecipacao: !!pInfo.isAntecipacao,
                        isGradeQueimada: !!pInfo.isGradeQueimada,
                        isAtrasado: !!pInfo.isAtrasado,
                        updatedAt: new Date().toISOString(),
                    }
                };

                await setDoc(patioDocRef, patioDataToSave, { merge: true });
                console.log(`Opera√ß√£o ${dtId} salva no p√°tio (com prioridade).`);
                return true;
            } catch (error) {
                console.error("Erro ao salvar opera√ß√£o no p√°tio:", error);
                displayError(`Ocorreu um erro ao salvar a opera√ß√£o no painel: Verifique suas permiss√µes.`, 5000);
                return false;
            }
        }

        async function findAndFillDriverData(event) {
            const cpfInput = event.target;
            const unmaskedCpf = cpfInput.value.replace(/\D/g, '');

            if (unmaskedCpf.length !== 11) return;
            if (!isAuthReady) return;

            const driverRef = doc(db, 'artifacts', appId, 'public', 'data', 'drivers', unmaskedCpf);

            try {
                const docSnap = await getDoc(driverRef);
                if (docSnap.exists()) {
                    fillFormFields(docSnap.data());
                    console.log("Motorista encontrado no Firebase.");
                } else {
                    const localData = localStorage.getItem(`heilo-driver-${unmaskedCpf}`);
                    if (localData) {
                        fillFormFields(JSON.parse(localData));
                        console.log("Motorista encontrado no LocalStorage.");
                    }
                }
            } catch (error) {
                console.error("Erro ao buscar motorista no Firebase:", error);
                displayError("Erro ao consultar o banco de dados de motoristas.", 4000);
            }
        }

        // =======================
        // ‚úÖ NOVO LAYOUT / FLUXOS
        // =======================
        function renderActionSelector() {
            currentMode = null;
            pendingUnloadDt = '';
            requireUnloadDtInForm = false;
            manualPresetType = '';
            manualDtIdOverride = '';
            hideManualExtras = false;
            showUnloadInputs = true;

            actionArea.innerHTML = `
                <div id="mode-root" class="space-y-3">
                    <div class="flex items-center justify-between gap-3">
                        <p class="font-semibold text-white">O que voc√™ quer fazer?</p>

                        <button id="contrast-toggle"
                                class="btn-ghost px-3 py-2 rounded-lg text-xs"
                                type="button"
                                title="Melhora a visibilidade das op√ß√µes">
                            Alto contraste
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <button data-mode="LOAD"
                                class="mode-btn btn-ghost w-full py-4 rounded-xl mode-tile flex flex-col items-center justify-center gap-2 text-center"
                                title="Carregamento usando DT (consulta na planilha)">
                            <div class="emoji">üöö</div>
                            <div class="label font-bold">Carregar</div>
</button>

                        <button data-mode="UNLOAD"
                                class="mode-btn btn-ghost w-full py-4 rounded-xl mode-tile flex flex-col items-center justify-center gap-2 text-center"
                                title="Descarregamento com DT de descarga (sem planilha)">
                            <div class="emoji">üì•</div>
                            <div class="label font-bold">Descarregar</div>
</button>

                        <button data-mode="BOTH"
                                class="mode-btn btn-ghost w-full py-4 rounded-xl mode-tile flex flex-col items-center justify-center gap-2 text-center sm:col-span-2"
                                title="Carga + Descarga (DT de carga + DT de descarga)">
                            <div class="emoji">üîÅ</div>
                            <div class="label font-bold">Carga + Descarga</div>
</button>

                        <button data-mode="LATA_INSUMO"
                                class="mode-btn btn-ghost w-full py-4 rounded-xl mode-tile flex flex-col items-center justify-center gap-2 text-center"
                                title="Sem DT: vai direto para dados do motorista">
                            <div class="emoji">ü•´</div>
                            <div class="label font-bold">Lata / Insumo</div>
</button>

                        <button data-mode="RITMO"
                                class="mode-btn btn-ghost w-full py-4 rounded-xl mode-tile flex flex-col items-center justify-center gap-2 text-center"
                                title="Ritmo: DT opcional (se vazio, gera ID interno)">
                            <div class="emoji">‚ö°</div>
                            <div class="label font-bold">Ritmo</div>
</button>
                    </div>

                    <p class="text-xs text-gray-400">
                        Dica: se a planilha estiver fora do ar, use os fluxos sem DT.
                    </p>
                </div>
`;

            // ‚úÖ Alto contraste (somente nas op√ß√µes) - persiste no localStorage
            const hcKey = "heilog-hc";
            const applyHc = (on) => {
                actionArea.classList.toggle("hc", !!on);
                try { localStorage.setItem(hcKey, on ? "1" : "0"); } catch {}
            };
            const hcSaved = (() => {
                try { return localStorage.getItem(hcKey) === "1"; } catch { return false; }
            })();
            applyHc(hcSaved);

            const hcBtn = document.getElementById("contrast-toggle");
            if (hcBtn) {
                hcBtn.addEventListener("click", () => {
                    const next = !actionArea.classList.contains("hc");
                    applyHc(next);
                });
            }


            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    await unlockAudio();
                    currentMode = btn.dataset.mode;
                    renderModeForm(currentMode);
                });
            });

            updateModeAvailability();
        }

        function updateModeAvailability() {
            const needsSheet = new Set(['LOAD', 'BOTH']);
            document.querySelectorAll('.mode-btn').forEach(btn => {
                const mode = btn.dataset.mode;
                if (!mode) return;
                if (needsSheet.has(mode)) {
                    const disabled = !isSheetReady;
                    btn.disabled = disabled;
                    btn.classList.toggle('opacity-50', disabled);
                    btn.classList.toggle('cursor-not-allowed', disabled);
                    btn.title = disabled ? 'Planilha n√£o carregou ainda.' : '';
                }
            });
        }

        function renderModeForm(mode) {
            resultsArea.innerHTML = '';
            pendingUnloadDt = '';
            requireUnloadDtInForm = false;
            manualPresetType = '';
            manualDtIdOverride = '';
            hideManualExtras = false;
            showUnloadInputs = true;

            const backBtn = `
                <button id="back-to-modes" class="btn-ghost w-full py-2 rounded-lg">‚¨Ö Voltar</button>
            `;

            let html = '';

            if (mode === 'LOAD') {
                html = `
                    <div class="space-y-3">
                        <p class="font-semibold text-white">Carregamento</p>
                        <input type="text" id="mode-dt" class="form-input w-full rounded-lg p-3" placeholder="Digite a DT (carregar)">
                        <button id="mode-go" class="btn-green w-full py-3 rounded-lg">Buscar DT</button>
                        ${backBtn}
                    </div>
                `;
            }

            if (mode === 'UNLOAD') {
                html = `
                    <div class="space-y-3">
                        <p class="font-semibold text-white">Descarregamento</p>
                        <input type="text" id="mode-unload-dt" class="form-input w-full rounded-lg p-3" placeholder="Digite a DT de descarga">
                        <button id="mode-go" class="btn-green w-full py-3 rounded-lg">Continuar</button>
                        ${backBtn}
                    </div>
                `;
            }

            if (mode === 'BOTH') {
                html = `
                    <div class="space-y-3">
                        <p class="font-semibold text-white">Carga + Descarga</p>
                        <input type="text" id="mode-dt" class="form-input w-full rounded-lg p-3" placeholder="Digite a DT (carga)">
                        <input type="text" id="mode-unload-dt" class="form-input w-full rounded-lg p-3" placeholder="Digite a DT de descarga">
                        <button id="mode-go" class="btn-green w-full py-3 rounded-lg">Buscar DT</button>
                        ${backBtn}
                    </div>
                `;
            }

            if (mode === 'LATA_INSUMO') {
                html = `
                    <div class="space-y-3">
                        <p class="font-semibold text-white">Lata / Insumo</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="pick-lata" class="btn-green py-3 rounded-lg">ü•´ Latas</button>
                            <button id="pick-insumo" class="btn-green py-3 rounded-lg">üß™ Insumo</button>
                        </div>
                        <p class="text-xs text-gray-400">Voc√™ vai direto pro formul√°rio do motorista (sem DT).</p>
                        ${backBtn}
                    </div>
                `;
            }

            if (mode === 'RITMO') {
                html = `
                    <div class="space-y-3">
                        <p class="font-semibold text-white">Ritmo</p>
                        <input type="text" id="mode-dt-optional" class="form-input w-full rounded-lg p-3" placeholder="DT (opcional)">
                        <button id="mode-go" class="btn-green w-full py-3 rounded-lg">Continuar</button>
                        ${backBtn}
                    </div>
                `;
            }

            actionArea.innerHTML = html;

            document.getElementById('back-to-modes')?.addEventListener('click', () => {
                renderActionSelector();
            });

            // Handlers
            if (mode === 'LOAD' || mode === 'BOTH') {
                const dtEl = document.getElementById('mode-dt');
                const unloadEl = document.getElementById('mode-unload-dt');
                document.getElementById('mode-go')?.addEventListener('click', async () => {
                    await unlockAudio();
                    const dt = dtEl?.value?.trim() || '';
                    if (!dt) return displayError('Digite a DT.', 4000);
                    if (!isSheetReady || database.length === 0) return displayError('Planilha ainda n√£o carregou. Tente novamente.', 4000);

                    pendingUnloadDt = (unloadEl?.value || '').trim();
                    requireUnloadDtInForm = (mode === 'BOTH');
                    showUnloadInputs = (mode === 'BOTH'); // s√≥ mostra DT Descarga no form quando for "2 DTs"

                    performSearchByDt(dt);
                });

                dtEl?.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        await unlockAudio();
                        document.getElementById('mode-go')?.click();
                    }
                });
                unloadEl?.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        await unlockAudio();
                        document.getElementById('mode-go')?.click();
                    }
                });
                dtEl?.focus();
            }

            if (mode === 'UNLOAD') {
                const unloadEl = document.getElementById('mode-unload-dt');
                document.getElementById('mode-go')?.addEventListener('click', async () => {
                    await unlockAudio();
                    const unloadDt = unloadEl?.value?.trim() || '';
                    if (!unloadDt) return displayError('Digite a DT de descarga.', 4000);

                    // Para descarregar: sem planilha -> vai direto pro formul√°rio (manual), com DT Descarga obrigat√≥ria
                    manualPresetType = 'Descarga';
                    hideManualExtras = true;      // deixa manual mais enxuto
                    showUnloadInputs = true;      // mostra DT Descarga no form
                    requireUnloadDtInForm = true; // obriga preencher (vamos pr√©-preencher com o que digitou)
                    pendingUnloadDt = unloadDt;

                    // usa a pr√≥pria DT de descarga como "ID" (p√°tio/print)
                    const dtId = normalizeDtId(unloadDt) || generateInternalId('DESC');
                    manualDtIdOverride = dtId;

                    showDriverForm([{ [headerMap.dts]: dtId }], {
                        modeLabel: 'Descarregamento',
                        isManualOverride: true
                    });
                });

                unloadEl?.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        await unlockAudio();
                        document.getElementById('mode-go')?.click();
                    }
                });
                unloadEl?.focus();
            }

            if (mode === 'LATA_INSUMO') {
                document.getElementById('pick-lata')?.addEventListener('click', async () => {
                    await unlockAudio();
                    manualPresetType = 'Latas';
                    hideManualExtras = true;
                    showUnloadInputs = false;         // n√£o precisa Nota/DT Descarga
                    requireUnloadDtInForm = false;
                    pendingUnloadDt = '';

                    manualDtIdOverride = generateInternalId('SEM_DT');
                    showDriverForm([{ [headerMap.dts]: manualDtIdOverride }], { modeLabel: 'Latas / sem DT', isManualOverride: true });
                });

                document.getElementById('pick-insumo')?.addEventListener('click', async () => {
                    await unlockAudio();
                    manualPresetType = 'Insumo';
                    hideManualExtras = true;
                    showUnloadInputs = false;
                    requireUnloadDtInForm = false;
                    pendingUnloadDt = '';

                    manualDtIdOverride = generateInternalId('SEM_DT');
                    showDriverForm([{ [headerMap.dts]: manualDtIdOverride }], { modeLabel: 'Insumo / sem DT', isManualOverride: true });
                });
            }

            if (mode === 'RITMO') {
                const optEl = document.getElementById('mode-dt-optional');
                document.getElementById('mode-go')?.addEventListener('click', async () => {
                    await unlockAudio();
                    manualPresetType = 'Ritmo';
                    hideManualExtras = true;
                    showUnloadInputs = false;
                    requireUnloadDtInForm = false;
                    pendingUnloadDt = '';

                    const typed = optEl?.value?.trim() || '';
                    const dtId = normalizeDtId(typed) || generateInternalId('RITMO');
                    manualDtIdOverride = dtId;

                    showDriverForm([{ [headerMap.dts]: dtId }], { modeLabel: 'Ritmo', isManualOverride: true });
                });

                optEl?.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        await unlockAudio();
                        document.getElementById('mode-go')?.click();
                    }
                });
                optEl?.focus();
            }
        }

        function performSearchByDt(query) {
            const q = query.trim();
            if (!q) { displayError("Digite um n√∫mero de DT para buscar."); return; }
            if (database.length === 0) { displayError("Os dados da planilha ainda n√£o foram carregados."); return; }

            const results = database.filter(row => (row[headerMap.dts] || '').toString().trim().toLowerCase() === q.toLowerCase());
            if (results.length > 0) {
                const deposito = results[0][headerMap.deposito] || '';
                const normalizedDeposito = deposito.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                if (normalizedDeposito.includes('FABRICA')) {
                    // Fluxo f√°brica -> formul√°rio motorista
                    showDriverForm(results, {
                        modeLabel: currentMode === 'BOTH' ? 'Carga + Descarga' : 'Carregamento',
                        isManualOverride: false
                    });
                } else {
                    // Outros destinos -> s√≥ mostra detalhes
                    displayStandardResults(results);
                }
            } else {
                displayNotFound(q);
            }
        }

        // --- FUN√á√ïES DE UI E MANIPULA√á√ÉO DO DOM ---
        function displayStandardResults(dataArray) {
            const firstResult = dataArray[0];
            const dt = firstResult[headerMap.dts] || 'N/A';
            const productListHtml = dataArray.map(item => `
                <div class="border-t border-gray-700/50 pt-2 mt-2">
                    <p class="text-sm text-gray-400">Descri√ß√£o do Produto</p>
                    <p class="text-lg">${item[headerMap.descricao] || 'N/A'}</p>
                    <p class="text-sm text-gray-400 mt-2">Quantidade</p>
                    <p class="text-lg">${item[headerMap.plt] || 'N/A'}</p>
                </div>
            `).join('');

            let resultsHtml = `
                <div class="bg-gray-800/80 p-6 rounded-xl border border-gray-700">
                    <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Detalhes para o DTS: ${dt}</h3>
                    <div class="space-y-2 text-gray-300">
                        <div>
                            <p class="text-sm text-gray-400">Destino</p>
                            <p class="text-lg">${firstResult[headerMap.deposito] || 'N/A'}</p>
                        </div>
            `;

            if ((firstResult[headerMap.deposito] || '').toUpperCase() === 'HEILO') {
                resultsHtml += `
                    <div class="pt-4 border-t border-gray-700/50">
                        <p class="text-sm text-gray-400">Endere√ßo de Entrega</p>
                        <p class="text-lg font-semibold">Rua Vereador Geraldo Nogueira da Silva, 5111, Ca√ßapava, SP, 12280-001</p>
                    </div>
                `;
            }

            resultsHtml += `
                        <h4 class="text-md font-semibold text-white pt-3">Itens da Carga:</h4>
                        ${productListHtml}
                    </div>
                </div>
            `;
            resultsArea.innerHTML = resultsHtml;
        }

        function showDriverForm(dataArray, options = {}) {
            const firstResult = dataArray[0] || {};
            const isManual = options.isManualOverride === true ? true : !firstResult[headerMap.cliente];

            const modeLabel = options.modeLabel || 'Opera√ß√£o';

            resultsArea.innerHTML = `
                <div class="bg-blue-900/40 p-6 rounded-xl border border-blue-700">
                    <div class="flex items-start justify-between gap-2">
                        <div>
                            <h3 class="text-xl font-bold text-white mb-1">${modeLabel}</h3>
                            <p class="text-blue-200 mb-4 text-sm">${isManual ? 'Preencha os dados do motorista (e opcionalmente os dados da opera√ß√£o).' : 'Preencha os dados do motorista.'}</p>
                        </div>
                        <button id="back-from-form" class="btn-ghost px-3 py-2 rounded-lg text-sm">‚¨Ö Voltar</button>
                    </div>

                    <div class="space-y-4">
                        ${isManual ? `
                            <div class="bg-black/20 p-3 rounded-lg border border-white/10">
                                <p class="text-xs text-gray-200 mb-2 font-semibold">Dados da Opera√ß√£o (opcional)</p>

                                <div ${hideManualExtras ? 'hidden' : ''}>
                                    <input type="text" id="manual-client" class="form-input w-full rounded-lg p-3 mb-2" placeholder="Cliente (opcional)">
                                </div>

                                <select id="manual-type" class="form-select w-full rounded-lg p-3 mb-2">
                                    <option value="">Tipo de Carga</option>
                                    <option value="Bulk">Bulk</option>
                                    <option value="Embalagem">Embalagem</option>
                                    <option value="Latas">Latas</option>
                                    <option value="Produto Acabado">Produto Acabado</option>
                                    <option value="Insumo">Insumo</option>
                                    <option value="Ritmo">Ritmo</option>
                                    <option value="Descarga">Descarga</option>
                                </select>

                                <div ${hideManualExtras ? 'hidden' : ''}>
                                    <input type="text" id="manual-plt" class="form-input w-full rounded-lg p-3 mb-2" placeholder="Quantidade (PLT) (opcional)">
                                </div>

                                <input type="text" id="manual-transportadora" class="form-input w-full rounded-lg p-3 mb-2" placeholder="Transportadora (opcional)">

                                <select id="manual-canal" class="form-select w-full rounded-lg p-3">
                                    <option value="">Canal (opcional)</option>
                                    <option value="Y001">Y001</option>
                                    <option value="Y002">Y002</option>
                                    <option value="Y004">Y004</option>
                                    <option value="Y006">Y006</option>
                                    <option value="Y055">Y055</option>
                                </select>

                                <div class="text-xs text-gray-300 mt-2">
                                    <span class="font-semibold">ID:</span> ${firstResult[headerMap.dts] || 'N/A'}
                                </div>
                            </div>
                        ` : ''}

                        <input type="text" id="driver-cpf" class="form-input w-full rounded-lg p-3" placeholder="Digite o CPF para buscar motorista">
                        <input type="text" id="driver-name" class="form-input w-full rounded-lg p-3" placeholder="Nome Completo do Motorista">
                        <input type="text" id="driver-phone" class="form-input w-full rounded-lg p-3" placeholder="Telefone com DDD">

                        <div class="flex gap-4">
                            <input type="text" id="driver-cnh" class="form-input w-full rounded-lg p-3" placeholder="N¬∫ CNH">
                            <input type="text" id="cnh-expiry" class="form-input w-full rounded-lg p-3" placeholder="Vencimento CNH (DD/MM/AAAA)">
                        </div>

                        <div class="grid grid-cols-3 gap-4">
                            <input type="text" id="truck-plate" class="form-input col-span-1 rounded-lg p-3" placeholder="Placa Cavalo">
                            <input type="text" id="trailer-plate" class="form-input col-span-1 rounded-lg p-3" placeholder="Placa Carreta">
                            <select id="truck-axles" class="form-select col-span-1 rounded-lg p-3">
                                <option value="">Eixos</option>
                                <option value="2">2 Eixos</option>
                                <option value="3">3 Eixos</option>
                                <option value="4">4 Eixos</option>
                                <option value="5">5 Eixos</option>
                                <option value="6">6 Eixos</option>
                                <option value="7">7 Eixos</option>
                                <option value="9">9 Eixos</option>
                            </select>
                        </div>

                        <input type="text" id="driver-renavam" class="form-input w-full rounded-lg p-3" placeholder="RENAVAM">

                        ${showUnloadInputs ? `
                            <div class="flex gap-4">
                                <input type="text" id="invoice-number" class="form-input w-full rounded-lg p-3" placeholder="Nota Fiscal (opcional)">
                                <input type="text" id="unload-dt" class="form-input w-full rounded-lg p-3" placeholder="DT de Descarga ${requireUnloadDtInForm ? '(obrigat√≥rio)' : '(opcional)'}">
                            </div>
                        ` : `
                            <input type="text" id="invoice-number" class="form-input w-full rounded-lg p-3" placeholder="Nota Fiscal (opcional)" hidden>
                            <input type="text" id="unload-dt" class="form-input w-full rounded-lg p-3" placeholder="DT de Descarga" hidden>
                        `}

                        <button id="generate-sheet-btn" class="btn-green w-full py-3 rounded-lg">Imprimir e Chamar</button>
                    </div>
                </div>
            `;

            document.getElementById('back-from-form')?.addEventListener('click', () => {
                // volta para o menu do modo atual (ou menu principal)
                if (currentMode) renderModeForm(currentMode);
                else renderActionSelector();
                resultsArea.innerHTML = '';
            });

            applyFormMasksAndValidations();

            // Prefills para modos (Lata/Insumo/Descarga/Ritmo)
            if (isManual) {
                const manualTypeEl = document.getElementById('manual-type');
                const manualClientEl = document.getElementById('manual-client');
                const manualPltEl = document.getElementById('manual-plt');
                const manualTranspEl = document.getElementById('manual-transportadora');

                if (manualTypeEl && manualPresetType) manualTypeEl.value = manualPresetType;
                if (manualClientEl && hideManualExtras && !manualClientEl.value) manualClientEl.value = 'N/A';
                if (manualPltEl && hideManualExtras && !manualPltEl.value) manualPltEl.value = '';
                if (manualTranspEl && firstResult[headerMap.transportadora]) manualTranspEl.value = firstResult[headerMap.transportadora];
            }

            // Prefill DT descarga
            const unloadEl = document.getElementById('unload-dt');
            if (unloadEl && pendingUnloadDt) unloadEl.value = pendingUnloadDt;

            document.getElementById('driver-cpf').addEventListener('input', findAndFillDriverData);
            document.getElementById('generate-sheet-btn').addEventListener('click', async () => {
                await unlockAudio();
                generateAndPrintSheet(dataArray, { isManual });
            });
        }

        function applyFormMasksAndValidations() {
            const cpfEl = document.getElementById('driver-cpf');
            if (cpfEl) cpfMask = IMask(cpfEl, { mask: '000.000.000-00' });

            const phoneEl = document.getElementById('driver-phone');
            if (phoneEl) phoneMask = IMask(phoneEl, { mask: '(00) 00000-0000' });

            const plateEl = document.getElementById('truck-plate');
            if (plateEl) plateEl.addEventListener('input', (e) => e.target.value = e.target.value.toUpperCase());
        }

        function fillFormFields(data) {
            document.getElementById('driver-name').value = data.name || '';
            document.getElementById('driver-cnh').value = data.cnh || '';
            document.getElementById('cnh-expiry').value = data.cnhExpiry || '';
            document.getElementById('truck-plate').value = data.truckPlate || '';
            document.getElementById('trailer-plate').value = data.trailerPlate || '';
            document.getElementById('truck-axles').value = data.axles || '';
            document.getElementById('driver-renavam').value = data.renavam || '';

            const manualTransp = document.getElementById('manual-transportadora');
            if (manualTransp && data.transportadora) {
                manualTransp.value = data.transportadora;
            }

            if (phoneMask && data.phone) phoneMask.unmaskedValue = String(data.phone).replace(/\D/g,'');
            else if (document.getElementById('driver-phone') && data.phone) document.getElementById('driver-phone').value = data.phone;
        }

        async function generateAndPrintSheet(originalDataArray, { isManual }) {
            // valida√ß√µes principais
            const nameEl = document.getElementById('driver-name');
            const cpfEl = document.getElementById('driver-cpf');
            const phoneEl = document.getElementById('driver-phone');
            const plateEl = document.getElementById('truck-plate');

            if (!validateField(nameEl, "Nome do motorista √© obrigat√≥rio.")) return;
            if (!validateField(cpfEl, "CPF √© obrigat√≥rio.", () => cpfMask.unmaskedValue.length === 11)) return;
            if (!validateField(phoneEl, "Telefone √© obrigat√≥rio.", () => phoneMask.unmaskedValue.length >= 10)) return;
            if (!validateField(plateEl, "Placa do cavalo √© obrigat√≥ria.")) return;

            // ‚úÖ valida DT descarga quando o modo exigir
            const unloadDtEl = document.getElementById('unload-dt');
            if (requireUnloadDtInForm && unloadDtEl) {
                if (!validateField(unloadDtEl, "DT de descarga √© obrigat√≥ria.", () => unloadDtEl.value.trim().length > 0)) return;
            }

            const firstOriginal = originalDataArray[0] || {};

            // Decide DT/ID para salvar no p√°tio
            const baseDt = String(firstOriginal[headerMap.dts] || '').trim();
            const dtFromOverride = String(manualDtIdOverride || '').trim();
            const dtToUse = dtFromOverride || baseDt || generateInternalId('SEM_DT');

            const driverData = {
                name: nameEl.value,
                cpf: cpfEl.value,
                phone: phoneEl.value,
                cnh: document.getElementById('driver-cnh').value,
                cnhExpiry: document.getElementById('cnh-expiry').value,
                truckPlate: plateEl.value,
                trailerPlate: document.getElementById('trailer-plate').value,
                axles: document.getElementById('truck-axles').value,
                renavam: document.getElementById('driver-renavam').value,
                invoice: (document.getElementById('invoice-number')?.value || ''),
                unloadDt: (document.getElementById('unload-dt')?.value || ''),
                registrationTime: Date.now(),
                dts: dtToUse,
                transportadora: isManual ? (document.getElementById('manual-transportadora')?.value || '') : (firstOriginal[headerMap.transportadora] || '')
            };

            // monta sheetData ANTES (manual tamb√©m)
            const sheetData = isManual ? [{
                ...firstOriginal,
                [headerMap.dts]: dtToUse,
                [headerMap.cliente]: (document.getElementById('manual-client')?.value || ''),
                [headerMap.produto]: (document.getElementById('manual-type')?.value || ''),
                [headerMap.plt]: (document.getElementById('manual-plt')?.value || ''),
                [headerMap.transportadora]: (document.getElementById('manual-transportadora')?.value || ''),
                [headerMap.canal]: (document.getElementById('manual-canal')?.value || ''),
                [headerMap.deposito]: 'F√ÅBRICA'
            }] : originalDataArray;

            const firstRowForPriority = sheetData[0] || {};
            const priorityInfo = getPriorityInfo(firstRowForPriority);

            const isSaved = await saveDriverData(driverData, firstRowForPriority, priorityInfo);
            if (!isSaved) return;

            buildPrintableSheet(
                driverData,
                sheetData,
                priorityInfo.isPriority,
                priorityInfo.isOtif,
                priorityInfo.isTop18,
                priorityInfo.isAntecipacao,
                priorityInfo.isGradeQueimada,
                priorityInfo.isAtrasado,
                isManual
            );

            // ‚úÖ print mais est√°vel
            window.onafterprint = () => {
                showCallPanel(driverData.name, priorityInfo.isPriority || priorityInfo.isGradeQueimada || priorityInfo.isAtrasado);
                window.onafterprint = null;
            };

            setTimeout(() => window.print(), 150);
        }

        function validateField(element, errorMessage, condition = () => element.value.trim() !== '') {
            if (!condition()) {
                element.classList.add('invalid');
                displayError(errorMessage, 4000);
                element.focus();
                return false;
            }
            element.classList.remove('invalid');
            return true;
        }

        function getPriorityInfo(sheetRow) {
            let isPriority = false, isOtif = false, isTop18 = false, isAntecipacao = false, isGradeQueimada = false, isAtrasado = false;
            if (!sheetRow) return { isPriority, isOtif, isTop18, isAntecipacao, isGradeQueimada, isAtrasado };

            // --- TOP18 vem do SEGMENTO (coluna XT ADICIONAL / no CSV) ---
            const segmento = (sheetRow[headerMap.xtAdicional] || '').toString().toUpperCase();
            isTop18 = segmento.includes('TOP18') || segmento.includes('TOP 18');

            const canal = (sheetRow[headerMap.canal] || '').toString().trim().toUpperCase();
            const dateStr = (sheetRow[headerMap.data] || '').toString().trim();
            const timeStr = (sheetRow[headerMap.agenda] || '').toString().trim();

            const parseScheduledDateTime = (dStr, tStr) => {
                if (!dStr || !/^\d{2}\/\d{2}\/\d{4}$/.test(dStr)) return null;
                if (!tStr) return null;
                const t = tStr.split(':');
                if (t.length < 2) return null;

                const [day, month, year] = dStr.split('/').map(v => parseInt(v, 10));
                const hours = parseInt(t[0], 10);
                const minutes = parseInt(t[1], 10);
                const seconds = t.length >= 3 ? parseInt(t[2], 10) : 0;

                if ([day, month, year, hours, minutes, seconds].some(n => Number.isNaN(n))) return null;
                return new Date(year, month - 1, day, hours, minutes, seconds);
            };

            const scheduledDateTime = parseScheduledDateTime(dateStr, timeStr);

            const OTIF_CANAIS = new Set(['Y001','Y002','Y055']);
            isOtif = OTIF_CANAIS.has(canal);

            if (!scheduledDateTime) {
                isPriority = isTop18 || isOtif;
                return { isPriority, isOtif, isTop18, isAntecipacao, isGradeQueimada, isAtrasado };
            }

            const now = new Date();

            const today = new Date(now); today.setHours(0, 0, 0, 0);
            const scheduledDay = new Date(scheduledDateTime); scheduledDay.setHours(0, 0, 0, 0);

            if (today < scheduledDay) {
                isAntecipacao = true;
            } else if (today > scheduledDay) {
                isGradeQueimada = true;
            } else {
                const plannedHour = scheduledDateTime.getHours();
                if (plannedHour >= 20 && plannedHour <= 23) {
                    isAntecipacao = true;
                } else {
                    const plannedPlus1h = scheduledDateTime.getTime() + (60 * 60 * 1000);
                    if (now.getTime() > plannedPlus1h) {
                        isAtrasado = true;
                    }
                }
            }

            isPriority = isOtif || isTop18 || isAntecipacao;
            return { isPriority, isOtif, isTop18, isAntecipacao, isGradeQueimada, isAtrasado };
        }

        // ===== FOLHA DE IMPRESS√ÉO COMPLETA (IGUAL AO ORIGINAL) =====
        function buildPrintableSheet(driverData, sheetDataArray, isPriority, isOtif, isTop18, isAntecipacao, isGradeQueimada, isAtrasado, isManual) {
            const now = new Date();
            const printDate = now.toLocaleDateString('pt-BR');
            const printTime = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const firstResult = sheetDataArray[0];

            let priorityHtml = '';
            if (isGradeQueimada) {
                priorityHtml = `<div class="border-4 border-black text-center p-2" style="background-color: #FBBF24;"><h2 class="font-extrabold tracking-wider" style="font-size: 22px;">GRADE QUEIMADA</h2></div>`;
            } else if (isAtrasado) {
                priorityHtml = `<div class="border-4 border-black text-center p-2" style="background-color: #FACC15;"><h2 class="font-extrabold tracking-wider" style="font-size: 22px;">ATRASADO</h2></div>`;
            } else if (isPriority) {
                let reasons = [];
                if (isTop18) reasons.push("TOP 18");
                if (isOtif) reasons.push("OTIF");
                if (isAntecipacao) reasons.push("Antecipa√ß√£o");
                priorityHtml = `<div class="border-4 border-black text-center p-2" style="background-color: #F87171;"><h2 class="font-extrabold tracking-wider" style="font-size: 22px;">PRIORIDADE</h2><p class="font-bold" style="font-size: 16px;">(${reasons.join(' / ')})</p></div>`;
            } else {
                priorityHtml = `<div class="border border-black text-center p-1"><h2 class="font-bold tracking-wider">STATUS</h2><p style="font-size: 14px;">(Normal)</p></div>`;
            }

            const allCanais = ['Y001', 'Y002', 'Y004', 'Y006', 'Y055'];
            const canalPrint = (firstResult[headerMap.canal] || '').toString().trim().toUpperCase();
            const canaisHtml = allCanais.map(c => `${c === canalPrint ? '[X]' : '[&nbsp;&nbsp;]'} ${c}`).join(' ');

            const productHeader = isManual ? "Tipo de Carga" : "Produto";
            const productTableHtml = `
                <table class="w-full text-left text-sm border-collapse border border-black">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="border border-black p-1">${productHeader}</th>
                            <th class="border border-black p-1 text-center">Quantidade (PLT)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sheetDataArray.map(item => `
                            <tr>
                                <td class="border border-black p-1 font-bold">${item[headerMap.produto] || 'N/A'}</td>
                                <td class="border border-black p-1 text-center font-bold">${item[headerMap.plt] || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('printable-area').innerHTML = `
                <div class="p-2 bg-white text-black font-sans text-xs print-main-container">
                    <header class="flex justify-between items-start mb-4 border-b-2 border-black pb-2">
                        <div class="flex flex-col items-center">
                            <div class="flex items-center gap-1">
                                <span class="text-[9px] font-bold">EST.</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="#E50025">
                                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                                </svg>
                                <span class="text-[9px] font-bold">1873</span>
                            </div>
                            <h1 class="text-3xl font-bold font-title tracking-wider">HEINEKEN</h1>
                        </div>
                        <div class="w-1/3 pt-1">${priorityHtml}</div>
                    </header>

                    <div class="text-center mb-2 text-sm">
                        <p>CANAL: ${canaisHtml}</p>
                    </div>

                    <div class="mb-2 border border-black p-2">
                        <table class="w-full text-left text-sm">
                            <tr>
                                <td class="w-1/2 pr-8 align-top">
                                    <p><strong>DATA/HORA:</strong> ${printDate} ${printTime}</p>
                                    <p><strong>MOTORISTA:</strong> ${driverData.name}</p>
                                    <p><strong>CPF:</strong> ${driverData.cpf}</p>
                                    <p><strong>PLACA:</strong> ${driverData.truckPlate}</p>
                                    <p><strong>CARRETA 1:</strong> ${driverData.trailerPlate}</p>
                                    <p><strong>EIXOS:</strong> ${driverData.axles || 'N/A'}</p>
                                    <p><strong>CELULAR:</strong> ${driverData.phone}</p>
                                </td>
                                <td class="w-1/2 align-top">
                                    <p><strong>CLIENTE:</strong></p>
                                    <p class="font-bold">${firstResult[headerMap.cliente] || 'N/A'}</p>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <div class="mb-2">${productTableHtml}</div>

                    <table class="w-full border-collapse border-2 border-black mb-2">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="border border-black p-1">MOTORISTA</th>
                                <th class="border border-black p-1">N¬∫ NOTA FISCAL</th>
                                <th class="border border-black p-1">N¬∫ TRANSPORTE</th>
                                <th class="border border-black p-1">DT DESCARGA</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border border-black p-1">
                                    <p>[ ] Carregamento</p>
                                    <p>[ ] Descarregamento</p>
                                </td>
                                <td class="border border-black p-1 text-center text-lg font-bold align-middle">${driverData.invoice || '---'}</td>
                                <td class="border border-black p-1 text-center text-lg font-bold align-middle">${firstResult[headerMap.dts] || 'N/A'}</td>
                                <td class="border border-black p-1 text-center text-lg font-bold align-middle">${driverData.unloadDt || '---'}</td>
                            </tr>
                            <tr>
                                <td colspan="4" class="border border-black p-1 text-xs">
                                    [X] Eu, motorista, estou ciente das regras de seguran√ßa vigentes no armaz√©m da HEINEKEN de Jacare√≠
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <table class="w-full border-collapse border border-black mb-2 text-xs">
                        <thead class="bg-gray-200 text-left">
                            <tr>
                                <th class="border border-black p-1">PROCESSO</th>
                                <th class="border border-black p-1">RESPONS√ÅVEL</th>
                                <th class="border border-black p-1">NOME</th>
                                <th class="border border-black p-1 w-1/3">ASSINATURA</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border border-black p-1 h-5">Confirma√ß√£o</td>
                                <td class="border border-black p-1 text-center">Motorista</td>
                                <td class="border border-black p-1">${driverData.name}</td>
                                <td class="border border-black p-1"></td>
                            </tr>
                            <tr>
                                <td class="border border-black p-1 h-5">Recebimento</td>
                                <td class="border border-black p-1 text-center">Conferente</td>
                                <td class="border border-black p-1"></td>
                                <td class="border border-black p-1"></td>
                            </tr>
                            <tr>
                                <td class="border border-black p-1 h-5">Confer√™ncia</td>
                                <td class="border border-black p-1 text-center">Conferente</td>
                                <td class="border border-black p-1"></td>
                                <td class="border border-black p-1"></td>
                            </tr>
                            <tr>
                                <td class="border border-black p-1 h-5">Conferiu? [ ] SIM [ ] N√ÉO</td>
                                <td class="border border-black p-1 text-center"></td>
                                <td class="border border-black p-1"></td>
                                <td class="border border-black p-1"></td>
                            </tr>
                            <tr>
                                <td class="border border-black p-1 h-5">Libera√ß√£o</td>
                                <td class="border border-black p-1 text-center">Faturista/Conferente</td>
                                <td class="border border-black p-1"></td>
                                <td class="border border-black p-1"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="border border-black p-2 mb-2">
                        <h3 class="text-center font-bold mb-1">RESPEITE AS REGRAS DE SEGURAN√áA:</h3>
                        <ul class="text-[9px] space-y-0.5" style="list-style-position: inside;">
                            <li>Proibido o uso de adornos.</li>
                            <li>Obrigat√≥rio o uso de todos os EPIs: Capacetes c/ jugular, Botas de Seguran√ßa, Colete refletivo, √ìculos de seguran√ßa, Luvas e M√°scaras.</li>
                            <li>Obrigat√≥rio Uso das faixas de pedestres.</li>
                            <li>Obrigat√≥ria dist√¢ncia de 5m entre pessoas e empilhadeiras.</li>
                            <li>Respeitar procedimentos HEINEKEN, Colaboradores e Seguran√ßa Patrimonial.</li>
                        </ul>
                    </div>

                    <div class="border border-black p-2">
                        <div class="flex justify-between items-center mb-1">
                            <h2 class="text-base font-bold">‚òÖ HEINEKEN UNIDADE JACARE√ç</h2>
                        </div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-0 text-xs">
                            <p><strong>DATA:</strong> ${printDate}</p>
                            <p><strong>HORA CHEGADA:</strong> ${printTime}</p>
                            <p><strong>NOME:</strong> ${driverData.name}</p>
                            <p><strong>CNH:</strong> ${driverData.cnh}</p>
                            <p><strong>CPF:</strong> ${driverData.cpf}</p>
                            <p><strong>TELEFONE:</strong> ${driverData.phone}</p>
                            <p><strong>EMPRESA:</strong> ${firstResult[headerMap.transportadora] || driverData.transportadora || ''}</p>
                            <p><strong>PLACA 1:</strong> ${driverData.truckPlate}</p>
                            <p><strong>PLACA 2:</strong> ${driverData.trailerPlate}</p>
                            <p><strong>EIXOS:</strong> ${driverData.axles || 'N/A'}</p>
                            <p><strong>RENAVAM:</strong> ${driverData.renavam || 'N/A'}</p>
                            <p><strong>NOTA FISCAL:</strong> ${driverData.invoice || ''}</p>
                            <p><strong>SETOR:</strong></p>
                        </div>
                    </div>
                </div>
            `;
        }
        // ===== /FOLHA COMPLETA =====

        function showCallPanel(driverName, isAlert) {
            clearTimeout(panelTimeout);
            callPanelMessage.innerHTML = `ATEN√á√ÉO ${driverName},<br>Aguarde a ser chamado, iremos mandar mensagem no celular`;

            if (isAlert) {
                callPanelContent.style.backgroundColor = '#fecaca';
                playSound(true);
            } else {
                callPanelContent.style.backgroundColor = '#e5e7eb';
                playSound(false);
            }

            callPanelOverlay.style.display = 'flex';
            panelTimeout = setTimeout(resetApp, 7000);
        }

        function playSound(isPrioritySound) {
            if (!audioUnlocked) return;
            const synth = new Tone.Synth().toDestination();
            if (isPrioritySound) {
                synth.triggerAttackRelease("C5", "8n", Tone.now());
                synth.triggerAttackRelease("G5", "8n", Tone.now() + 0.2);
            } else {
                synth.triggerAttackRelease("C4", "8n", Tone.now());
            }
        }

        function resetApp() {
            callPanelOverlay.style.display = 'none';
            resultsArea.innerHTML = '';
            renderActionSelector();
            clearTimeout(panelTimeout);
        }

        function displayError(message, duration = 0) {
            document.getElementById('temp-alert')?.remove();
            const alertDiv = document.createElement('div');
            alertDiv.id = 'temp-alert';
            alertDiv.className = 'bg-red-500 text-white p-3 rounded-lg mb-4 text-center';
            alertDiv.textContent = message;
            resultsArea.insertAdjacentElement('afterbegin', alertDiv);
            if (duration > 0) {
                setTimeout(() => alertDiv.remove(), duration);
            }
        }

        function displayNotFound(query) {
            resultsArea.innerHTML = `
                <div class="bg-yellow-900/50 border border-yellow-700 text-yellow-300 p-4 rounded-xl text-center">
                    <p class="font-semibold">DT "${query}" n√£o encontrado na planilha.</p>
                    <button id="manual-form-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all">
                        Criar Folha de Marca√ß√£o Manual
                    </button>
                </div>
            `;
            document.getElementById('manual-form-btn').addEventListener('click', async () => {
                await unlockAudio();
                // Manual com DT digitada como ID
                manualPresetType = '';
                hideManualExtras = false;
                showUnloadInputs = true;
                requireUnloadDtInForm = false;
                pendingUnloadDt = '';

                manualDtIdOverride = normalizeDtId(query) || generateInternalId('MANUAL');
                showDriverForm([{ [headerMap.dts]: manualDtIdOverride }], { modeLabel: 'Marca√ß√£o Manual', isManualOverride: true });
            });
        }

        // --- Event Listeners ---
        closePanelBtn.addEventListener('click', resetApp);
        callPanelOverlay.addEventListener('click', (e) => { if (e.target === callPanelOverlay) resetApp(); });

        // --- Ponto de Entrada da Aplica√ß√£o ---
        window.addEventListener('load', initializeAppLogic);

    </script>
</body>
</html>
